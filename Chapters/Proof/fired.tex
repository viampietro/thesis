%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% FALLING EDGE EQUAL FIRED LEMMA %%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lemma}[Falling Edge Equal Fired]
  \label{lem:fe-equal-fired}
  \fehyps{} then\\
  $\forall{}t,id_t~s.t.~\gamma(t)=id_t$ and
  $\sigma'(id_t)=\sigma'_t,~t\in{}Fired(s')\Leftrightarrow\sigma'_t("fired")=true$.
\end{lemma}

\begin{proof}
  Given a $t\in{}T$, and an $id_t$, prove both senses of the equivalence.

  \begin{enumerate}
  \item $t\in{}Fired(s')\Rightarrow\sigma'_t("fired")=true$.
    
    By definition of $t\in{}Fired(s')$.
    
    \begin{itemize}
    \item
      $t\in{}Fired(s')\equiv\exists{}fset\subseteq{}T,~s.t.,~IsFiredSet(s',fset)~\land~t\in{}fset$.
    \end{itemize}

    Then, apply Lemma~\nameref{lem:fe-equal-fset}.    
  \end{enumerate}

  \begin{enumerate}[resume]
  \item $\sigma'_t("fired")=true\Rightarrow{}t\in{}Fired(s')$

    We can prove that
    $\forall{}sitpn,s,\exists{}fset~s.t.~IsFiredSet(s,fset)$.

    Then, by specializing the above lemma, we can apply
    Lemma~\nameref{lem:fe-equal-fset} to complete the goal.
  \end{enumerate}


\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% FALLING EDGE EQUAL FIRED SET LEMMA %%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{lemma}[Falling Edge Equal Fired Set]
  \label{lem:fe-equal-fset}
  \fehyps{} then\\
  $\forall{}t,id_t~s.t.~\gamma(t)=id_t$ and $\sigma'(id_t)=\sigma'_t$
  and
  $\forall{}fset\subseteq{}T,$\\
  $~IsFiredSet(s',fset)\Rightarrow{}t\in{}fset\Leftrightarrow\sigma'_t("fired")=true$.
\end{lemma}

\begin{proof}
  Given a $t\in{}T$, a $fset\subseteq{}T$ and a proof of
  $IsFiredSet(s',fset)$. Unfold the definition of the $IsFiredSet$
  relation:
  \begin{itemize}
  \item $IsFiredSet(s',fset)\equiv{}IsFiredSetAux(s',\emptyset,T,fset)$.
  \end{itemize}
  Then, apply Lemma~\nameref{lem:fe-equal-fset-aux}.

\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% FALLING EDGE EQUAL FIRED SET AUX LEMMA %%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lemma}[Falling Edge Equal Fired Set Aux]
  \label{lem:fe-equal-fset-aux}
  \fehyps{} and\\
  $\forall{}t,id_t~s.t.~\gamma(t)=id_t$ and $\sigma'(id_t)=\sigma'_t$
  and $\forall{}fired\subseteq{}T,~T_i\subseteq{}T,~fset\subseteq{}T,$
  assume that:
  \begin{itemize}
  \item $IsFiredSetAux(s',fired,T_i,fset)$
  \item EH (Extra. Hypothesis):\\
    $\forall{}t',id_{t'},(t'\in{}fired\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
    
    \hspace{13ex}$\land$
    $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired~\lor~{}t'\in{}T_i)$.
  \end{itemize}
  then $t\in{}fset\Leftrightarrow\sigma'_t("fired")=\mathtt{true}$.
\end{lemma}

\begin{proof}
  Given a $t,id_t,fired,T_i,fset$, reason by induction on
  $IsFiredSetAux$.

  \begin{itemize}
  \item BASE CASE. Trivial.
  \item IND. CASE.
    \begin{itemize}
    \item $IsTopPriorityList(T_i,\emptyset,\emptyset,tp)$
    \item $ElectFired(s',fired,tp,fired')$
    \item $FiredAux(s',fired',T_i\setminus{}tp,fset)$
    \item IH: 
      $\big(\forall{}t'\in{}T,id_{t'},(t'\in{}fired'\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$\\
      $\land$
      $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired'~\lor~{}t'\in{}T_i\setminus{}tp)\big)\Rightarrow$\\
      $t\in{}fset\Leftrightarrow\sigma'_t("fired")=true$.
    \end{itemize}
    Apply IH, then, the new goal is:\\
    $\forall{}t',id_{t'},~(t'\in{}fired'\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$\\
    $\land$
    $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired'~\lor~{}t'\in{}T_i\setminus{}tp)$

    Apply Lemma~\nameref{lem:elect-fired-equal-fired} to solve the goal.
    
  \end{itemize}
  
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% ELECT FIRED EQUAL FIRED %%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lemma}[Elect Fired Equal Fired]
  \label{lem:elect-fired-equal-fired}
  \fehyps and\\
  $\forall{}t,id_t,~fired,fired'\subseteq{}T,~T_i,~tp\subseteq{}T_i,~fset,$
  assume that:
  \begin{itemize}
  \item $IsTopPriorityList(T_i,\emptyset,\emptyset,tp)$
  \item $ElectFired(s',fired,tp,fired')$
  \item $FiredAux(s',fired',T_i\setminus{}tp,fset)$
  \item EH (Extra. Hypothesis):\\
    {\fontsize{8}{11}\selectfont $\forall{}t',id_{t'},$
      
      $(t'\in{}fired\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
      $\land$
      $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired~\lor~{}t'\in{}T_i)$}
  \end{itemize}
  then\\
  {\fontsize{9}{11}\selectfont$\big(t\in{}fired'\Rightarrow\sigma'_t("fired")=\mathtt{true}\big)$
  $\land\big(\sigma'_t("fired")=\mathtt{true}\Rightarrow{}t\in{}fired'\lor{}t\in{}T_i\setminus{}tp\big)$}.
\end{lemma}

\begin{proof}
  Reason by induction on the $ElectFired$ relation.

  BASE CASE. Trivial.
  
  2 INDUCTIVE CASES.

  \begin{enumerate}
  \item CASE $t_0$ is elected to be fired.
    \begin{itemize}
    \item $IsTopPriorityList(T_i,\emptyset,\emptyset,\{t_0\}\cup{}tp)$
    \item $ElectFired(s',fired\cup\{t_0\},tp,fired')$
    \item $t_0\in{}Firable(s')$
    \item $t_0\in{}Sens(s'.M-\sum\limits_{t_i\in{}Pr(t_0,fired)}pre(t_i))$
    \item $Pr(t_0,fired)=\{t_i\vert{}t_i\succ{}t_0\land{}t_i\in{}fired\}$
    \item EH: $\forall{}t'\in{}T,id_{t'},(t'\in{}fired\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
    
      \hspace{13ex}$\land$
      $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired~\lor~{}t'\in{}T_i)$
    \item IH:\\
      $\forall{}T_i\subseteq{}T,~$
      $\big(\forall{}t'\in{}T,id_{t'},(t'\in{}fired\cup\{t_0\}\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
      $\land$\\
      $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired\cup\{t_0\}~\lor~{}t'\in{}T_i)\big)\Rightarrow$\\
      $IsTopPriorityList(T_i,\emptyset,\emptyset,tp)\Rightarrow$\\
      $\forall{}t\in{}T,~\big(t\in{}fired'\Rightarrow\sigma'_t("fired")=\mathtt{true}\big)$\\
      $\land$
      $\big(\sigma'_t("fired")=\mathtt{true}\Rightarrow{}t\in{}fired'\lor{}t\in{}T_i\setminus{}tp\big)$\\
    \end{itemize}
    GOAL:\\
    $\forall{}t\in{}T,~\big(t\in{}fired'\Rightarrow\sigma'_t("fired")=\mathtt{true}\big)$\\
    $\land$
    $\big(\sigma'_t("fired")=\mathtt{true}\Rightarrow{}t\in{}fired'\lor{}t\in{}T_i\setminus{}\{t_0\}\cup{}tp\big)$\\
    
    Apply IH with $T_i\setminus\{t_0\}$, then, the hard case to prove is:\\
    $\forall{}t'\in{}T,id_{t'},~$
    $(t'\in{}fired\cup\{t_0\}\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
    $\land$\\
    $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired\cup\{t_0\}~\lor~{}t'\in{}T_i\setminus\{t_0\})$
    \begin{enumerate}
    \item Assume $t'\in{}fired\cup\{t_0\}$, prove $\sigma'_{t'}("fired")=\mathtt{true}$.
      \begin{itemize}
      \item If $t'\in{}fired$, then assumption.
      \item If $t'=t_0$, then, introduce the expression qualifying
        ``fired'':
        $\sigma_{t'}("fired")=\sigma_{t'}("s\_firable").\sigma_{t'}("s\_priority\_combination")$\\\\
        Then, we can show that: 
        \begin{itemize}
        \item $\sigma_{t'}("s\_firable")=\mathtt{true}$ by applying
          Lemma~\nameref{lem:fe-equal-firable}
        \item $\sigma_{t'}("s\_priority\_combination")=\mathtt{true}$
          by applying Lemma~\nameref{lem:stab-compute-pcomb}.
        \end{itemize}

        Then, it is trivial to show that $\sigma_{t'}("fired")=\mathtt{true}$.
      \end{itemize}
      
    \item Assume $\sigma'_{t'}("fired")=\mathtt{true}$, prove $t'\in{}fired\cup\{t_0\}~\lor~{}t'\in{}T_i\setminus{}\{t_0\}$.\\

      Thanks to EH, we know that: $t'\in{}fired\lor{}t'\in{}T_i$.
      \begin{itemize}
      \item CASE $t'\in{}fired$, trivial to show $t'\in{}fired\cup\{t_0\}$.
      \item CASE $t'\in{}T_i$. We know that $t_0\in{}T_i$, therefore,
        either $t'\in{}T_i\setminus{}\{t_0\}$ (assumption) or $t'=t_0$
        (then, $t'\in{}fired\cup\{t_0\}$).
      \end{itemize}
    \end{enumerate}
  \end{enumerate}

  \begin{enumerate}[resume]
  \item CASE $t_0$ is not elected to be fired.
    \begin{itemize}
    \item $IsTopPriorityList(T_i,\emptyset,\emptyset,\{t_0\}\cup{}tp)$
    \item $ElectFired(s',fired,tp,fired')$
    \item $\neg\big(t_0\in{}Firable(s')\land{}t_0\in{}Sens(s'.M-\sum\limits_{t_i\in{}Pr(t_0,fired)}pre(t_i))\big)$
    \item $Pr(t_0,fired)=\{t_i\vert{}t_i\succ{}t_0\land{}t_i\in{}fired\}$
    \item EH:\\
      {\fontsize{9}{11}\selectfont$\forall{}t'\in{}T,id_{t'},$\\
      $(t'\in{}fired\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
      $\land$
      $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired~\lor~{}t'\in{}T_i)$.}
    \item IH:\\
      {\fontsize{9}{11}\selectfont$\forall{}T_i\subseteq{}T,~$\\
      $\big(\forall{}t'\in{}T,id_{t'},(t'\in{}fired\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
      $\land$\\
      $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired~\lor~{}t'\in{}T_i)\big)\Rightarrow$\\
      $IsTopPriorityList(T_i,\emptyset,\emptyset,tp)\Rightarrow$\\
      $\forall{}t\in{}T,~\big(t\in{}fired'\Rightarrow\sigma'_t("fired")=\mathtt{true}\big)$\\
      $\land$
      $\big(\sigma'_t("fired")=\mathtt{true}\Rightarrow{}t\in{}fired'\lor{}t\in{}T_i\setminus{}tp\big)$}
    \end{itemize}
    GOAL:\\
    $\forall{}t\in{}T,~\big(t\in{}fired'\Rightarrow\sigma'_t("fired")=\mathtt{true}\big)$\\
    $\land$
    $\big(\sigma'_t("fired")=\mathtt{true}\Rightarrow{}t\in{}fired'\lor{}t\in{}T_i\setminus{}\{t_0\}\cup{}tp\big)$\\
    
    Apply IH with $T_i\setminus\{t_0\}$, then, the hard case to prove is:\\
    $\forall{}t'\in{}T,id_{t'},~$
    $(t'\in{}fired\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
    $\land$\\
    $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired~\lor~{}t'\in{}T_i\setminus\{t_0\})$
    \begin{enumerate}
    \item Prove $t'\in{}fired\Rightarrow\sigma'_{t'}("fired")=\mathtt{true}$ (assumption).      
    \item Assume $\sigma'_{t'}("fired")=\mathtt{true}$, prove $t'\in{}fired~\lor~{}t'\in{}T_i\setminus{}\{t_0\}$.\\

      Thanks to EH, we know that: $t'\in{}fired\lor{}t'\in{}T_i$.
      \begin{itemize}
      \item CASE $t'\in{}fired$ (assumption).
      \item CASE $t'\in{}T_i$. We know that $t_0\in{}T_i$, therefore,
        either $t'\in{}T_i\setminus{}\{t_0\}$ (assumption) or $t'=t_0$.\\

        Then, we need to show a contradiction by proving\\
        $t'\in{}Firable(s')\land{}t'\in{}Sens(s'.M-\sum\limits_{t_i\in{}Pr(t',fired)}pre(t_i))$\\
        based on $\sigma'_{t'}("fired")=\mathtt{true}$.

        We know
        \begin{eqnarray*}
          \sigma'_{t'}("fired")=&\sigma'_{t'}("s\_firable").\sigma'_{t'}("s\_priority\_combination")\\
                               =&\mathtt{true}\\
        \end{eqnarray*}
        \begin{itemize}
        \item Show $t'\in{}Firable(s')$ by applying Lemma~\nameref{lem:fe-equal-firable}.
        \item Show
          $t'\in{}Sens(s'.M-\sum\limits_{t_i\in{}Pr(t',fired)}pre(t_i))$
          by applying Lemma~\nameref{lem:stab-compute-pcomb} (needs a
          proof of $t\in{}Firable(s')$ to be applied).
        \end{itemize}
      \end{itemize}
    \end{enumerate}
  \end{enumerate}
  
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% STABILIZE COMPUTE PRIORITY COMBINATION AFTER FALLING EDGE %%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lemma}[Stabilize Compute Priority Combination After Falling Edge]
  \label{lem:stab-compute-pcomb}
  \fehyps{} and\\
  $\forall{}t,id_t,\sigma'_t$ s.t. $\gamma(t)=id_t$ and $\sigma'(id_t)=\sigma'_t$,\\
  $\forall{}fired,fired',~T_i,~tp,~fset,$ assume that:
  \begin{itemize}
  \item $IsTopPriorityList(T_i,\emptyset,\emptyset,\{t\}\cup{}tp)$
  \item $ElectFired(s',fired,tp,fired')$
  \item $FiredAux(s',fired',T_i\setminus{}\{t\}\cup{}tp,fset)$
  \item EH (Extra. Hypothesis):\\
    {\fontsize{8}{11}\selectfont
      $\forall{}t'\in{}T,id_{t'},$
      
      $(t'\in{}fired\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
      $\land$
      $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired~\lor~{}t'\in{}T_i)$.}
  \item $t\in{}Firable(s')$
  \end{itemize}
  then\\
  {\fontsize{9}{11}\selectfont$t\in{}Sens(s'.M-\sum\limits_{t_i\in{}Pr(t,fired)}pre(t_i))
    \Leftrightarrow\sigma'_t("s\_priority\_combination")=\mathtt{true}$}
\end{lemma}

\begin{proof}
  We know
  $\sigma'_t("s\_priority\_combination")=\prod\limits_{i=0}^{\vert{}input(t)\vert-1}\sigma'_t("pauths")(i)$.
  Then, apply Lemma~\nameref{lem:stab-compute-pauths} to solve the goal.
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% STABILIZE COMPUTE PRIORITY AUTHORIZATIONS AFTER FALLING EDGE %%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lemma}[Stabilize Compute Priority Authorizations After Falling Edge]
  \label{lem:stab-compute-pauths}
  \fehyps{} and\\
  $\forall{}t,id_t,\sigma'_t$ s.t. $\gamma(t)=id_t$ and $\sigma'(id_t)=\sigma'_t$,\\
  $\forall{}fired,fired',~T_i,~tp,~fset,$ assume that:
  \begin{itemize}
  \item $IsTopPriorityList(T_i,\emptyset,\emptyset,\{t\}\cup{}tp)$
  \item $ElectFired(s',fired,tp,fired')$
  \item $FiredAux(s',fired',T_i\setminus{}\{t\}\cup{}tp,fset)$
  \item EH (Extra. Hypothesis):\\
    {\fontsize{8}{11}\selectfont
      $\forall{}t'\in{}T,id_{t'},$
      
      $(t'\in{}fired\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
      $\land$
      $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired~\lor~{}t'\in{}T_i)$.}
    
  \item $t\in{}Firable(s')$
  \end{itemize}
  then\\
  {\fontsize{8}{11}\selectfont$t\in{}Sens(s'.M-\sum\limits_{t_i\in{}Pr(t,fired)}pre(t_i))
    \Leftrightarrow$\\
    $\forall{}i\in[0,\sigma'_t("input\_arcs\_number")-1],~\sigma'_t("pauths")(i)=\mathtt{true}$}\\
\end{lemma}

\begin{proof}
  Show the two sides of the equivalence.
  
  \begin{enumerate}
  \item
    Assume $t\in{}Sens(s'.M-\sum\limits_{t_i\in{}Pr(t,fired)}pre(t_i))$,\\
    show $\forall{}i\in[0,\sigma'_t("input\_arcs\_number")-1],~\sigma'_t("pauths")(i)=\mathtt{true}$.\\

    Reason on the cardinality of the set of input places of $t$. 2
    CASES.
    \begin{itemize}
    \item CASE $\vert{}input(t)\vert=0$.

      Then $\sigma'_t("input\_arcs\_number")=1$ and $i=0$.

      Then, by construction, $\mathtt{id_t.pauths(0)}$ is connected to
      the $\mathtt{true}$ constant in the input map of Transition
      component $id_t$.

      Then, $\sigma'_t("pauths")(0)=\mathtt{true}$.
    \item CASE $\vert{}input(t)\vert>0$.

      Then, for all $i\in[0,\sigma'_t("input\_arcs\_number")-1]$,
      exists a place $p$ and an arc $a$ such that $pre(p,t)=a$.

      Then, by construction, there exists a Place component $id_p$
      implementing place $p$.

      Reason on $a$.

      \begin{itemize}
      \item CASE $a=(\omega,\mathtt{test})$ or $a=(\omega,\mathtt{inhib})$.

        Then, by construction, $\mathtt{id_t.pauths(i)}$ is connected to
        the $\mathtt{true}$ constant in the input map of Transition
        component $id_t$. 

        Then, $\sigma'_t("pauths")(i)=\mathtt{true}$.
      \item CASE $a=(\omega,\mathtt{basic})$, then 2 CASES.

        \begin{itemize}
        \item CASE For all pair of transitions in $output_c(p)$, all
          conflicts are solved by mutual exclusion.

          Then, by construction, $\mathtt{id_p.pauths}$ is an unconnected
          (i.e, $\mathtt{open}$) port, and $\mathtt{id_t.pauths(i)}$ is
          connected to the \texttt{true} constant.

          Then, $\sigma'_t("pauths")(i)=\mathtt{true}$.
        \item CASE The priority relation is a strict total order over
          the set $output_c(p)$.

          Then, by construction, there exists an index $j$ and a
          signal $sig$ connecting $\mathtt{id_p.pauths(j)}$ to $\mathtt{id_t.pauths(i)}$.

          Then, we can deduce that $\sigma'_t("pauths")(i)=\sigma'("sig")=\sigma'_p("pauths")(j)$.

          Then, we can specialize the definition of
          $t\in{}Sens(s'.M-\sum\limits_{t_i\in{}Pr(t,fired)}pre(t_i))$
          with place $p$, and $pre(p,t)=(\omega,\mathtt{basic})$ to
          get
          $s'.M(p)-\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)\ge\omega$.
          
          Then, we can show that
          $\sigma'_p("pauths")(j)=\mathtt{true}$ by applying
          Lemma~\nameref{lem:stab-compute-ind-pauth}.

          Then, the goal is trivially solved by rewriting.
        \end{itemize}
        
      \end{itemize}
    \end{itemize}
    
  \item Assume $\forall{}i\in[0,\sigma'_t("input\_arcs\_number")-1],~\sigma'_t("pauths")(i)=\mathtt{true}$,\\
    show $t\in{}Sens(s'.M-\sum\limits_{t_i\in{}Pr(t,fired)}pre(t_i))$.\\

    Then, unfold the definition of the $Sens$ relation.

    $\forall{}p\in{}P,\omega\in\mathbb{N}^{*},~$\\
    $\big(pre(p,t)=(\omega,\mathtt{basic})\lor{}pre(p,t)=(\omega,\mathtt{test})\Rightarrow$\\
    ${}s'.M(p)-\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)\ge\omega\big)$\\
    $\land{}$
    $\big(pre(p,t)=(\omega,\mathtt{inhib}))\Rightarrow$
    ${}s'.M(p)-\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)<\omega\big)$

    Then, treat the 3 different cases.

    \begin{enumerate}
    \item Assume $pre(p,t)=(\omega,\mathtt{test})$,\\
      show $s'.M(p)-\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)\ge\omega$.

      Then, by assuming that the priority relation is well-defined,
      there exists no transition $t_i$ connected by a $\mathtt{basic}$
      arc to $p$ that verified $t_i\succ{}t$. This is because $t$ is
      connected to $p$ by a $\mathtt{test}$ arc; thus, $t$ is not in
      conflict with the other output transitions of $p$; thus, there
      is no relation of priority between $t$ and the output of $p$.

      Then, we can deduce that
      $\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)=0$.

      Then, the new goal is $s'.M(p)\ge\omega$.

      That we can prove because we know $t\in{}Firable(s')$, thus,
      $t\in{}Sens(s'.M)$, thus, $s'.M(p)\ge\omega$.
      
    \item Assume $pre(p,t)=(\omega,\mathtt{inhib})$,\\
      show $s'.M(p)-\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)<\omega$.

      Use the same strategy as above.
      
    \item Assume $pre(p,t)=(\omega,\mathtt{basic})$,\\
      show
      $s'.M(p)-\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)\ge\omega$.

      Then, there are 2 CASES.

      \begin{enumerate}
      \item CASE For all pair of transitions in $output_c(p)$, all
        conflicts are solved by mutual exclusion.

        Then, assuming that the priority relation is well-defined, it
        must not be defined over the set $output_c(t)$, and we know
        that $t\in{}output_c(p)$ since
        $pre(p,t)=(\omega,\mathtt{basic})$.

        Then, there exists no transition $t_i$ connected to $p$ by a
        $\mathtt{basic}$ arc that verifies $t_i\succ{}t$.

        Then, we can deduce $\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)=0$.
        
        Then, the new goal is $s'.M(p)\ge\omega$.

        We know $t\in{}Firable(s')$, thus, $t\in{}Sens(s'.M)$, thus,
        $s'.M(p)\ge\omega$.
        
      \item CASE The priority relation is a strict total order over
        the set $output_c(p)$.

        Assuming $pre(p,t)=(\omega,\mathtt{basic})$, then, by
        construction, there exist:
        \begin{itemize}
        \item a Place component $id_p$
          implementing place $p$
          
        \item two indexes
          $i\in{}[0,\sigma'_t("input\_arcs\_number")-1]$ and
          $j\in{}[0,\sigma'_p("output\_arcs\_number")-1]$
          
        \item a signal $sig$ connecting $\mathtt{id_p.pauths(j)}$ to
          $\mathtt{id_t.pauths(i)}$
        \end{itemize}

        Then, we can deduce that $\sigma'_t("pauths")(i)=\sigma'("sig")=\sigma'_p("pauths")(j)$.
        
        Then, by specializing
        $\forall{}i\in[0,\sigma'_t("input\_arcs\_number")-1],~\sigma'_t("pauths")(i)=\mathtt{true}$
        with $i$, we can deduce
        $\sigma'_t("pauths")(i)=\sigma'("sig")=\sigma'_p("pauths")(j)=true$.

        Then, we have all the premises necessary to apply
        Lemma~\nameref{lem:stab-compute-ind-pauth}, and thus to solve
        the goal.
      \end{enumerate}
      
    \end{enumerate}
  \end{enumerate}
  
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% STABILIZE COMPUTE INDIVIDUAL PRIORITY AUTHORIZATION AFTER %%%%%%%%%%
%%%%%%%%%% FALLING EDGE                                              %%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lemma}[Stabilize Compute Individual Priority Authorization
  After Falling Edge]
  \label{lem:stab-compute-ind-pauth}
  \fehyps{} and\\
  $\forall{}t,id_t,\sigma'_t,$ s.t. $\gamma(t)=id_t$ and
  $\sigma'(id_t)=\sigma'_t$,\\
  $\forall{}p,id_p,\sigma'_p,$ s.t. $\gamma(p)=id_p$ and
  $\sigma'(id_p)=\sigma'_p$,\\
  $\forall{}fired,fired',~T_i,~tp,~fset,~sig\in{}Sigs(\Delta),~i,j\in\mathbb{N},~\omega\in\mathbb{N}$,
  assume that:
  \begin{itemize}
  \item $IsTopPriorityList(T_i,\emptyset,\emptyset,\{t\}\cup{}tp)$
  \item $ElectFired(s',fired,tp,fired')$
  \item $FiredAux(s',fired',T_i\setminus{}\{t\}\cup{}tp,fset)$
  \item EH (Extra. Hypothesis):\\
    {\fontsize{8}{11}\selectfont
      $\forall{}t'\in{}T,id_{t'},$
      
      $(t'\in{}fired\Rightarrow\sigma'_{t'}("fired")=\mathtt{true})$
      $\land$
      $(\sigma'_{t'}("fired")=\mathtt{true}\Rightarrow{}t'\in{}fired~\lor~{}t'\in{}T_i)$.}
  \item $\mathtt{id_p.pauths(j)\Rightarrow{}sig\Rightarrow{}id_t.pauths(i)}$
  \item $pre(p,t)=(\omega,\mathtt{basic})$
  \end{itemize}
  then
  {\fontsize{8}{11}\selectfont$\sigma'_p("pauths")(j)=\mathtt{true}$
    $\Leftrightarrow{}s'.M(p)-\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)\ge\omega$}.
\end{lemma}

\begin{proof}
  From the behavior of the VHDL Place component, we can deduce:\\
  {\fontsize{8}{11}\selectfont$\sigma'_p("pauths")(j)=true\Leftrightarrow$
    $\sigma'_p("s\_marking")-\sum\limits_{k\in{}HPF(\sigma'_p,j)}\sigma'_p("out\_arc\_w")(k)\ge\sigma'_p("out\_arc\_w")(j)$
    where
    $k\in{}HPF(\sigma'_p,j)\equiv{}k\in[0,j-1]\land\sigma'_p("out\_arc\_t")(k)=\mathtt{basic}\land\sigma'_p("out\_t\_fired")(k)=\mathtt{true}$}

  \noindent{}Then, the new goal is:\\
  $\sigma'_p("s\_marking")-\sum\limits_{k\in{}HPF(\sigma'_p,j)}\sigma'_p("out\_arc\_w")(k)\ge\sigma'_p("out\_arc\_w")(j)$
  $\Leftrightarrow{}s'.M(p)-\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)\ge\omega$.

  \noindent{}Proof by reflexivity. 3 subgoals.
  \begin{enumerate}
  \item Show $s'.M(p)=\sigma'_p("s\_marking")$.

    From $\gamma\vdash{}s\sim\sigma$, we know $s.M(p)=\sigma_p("s\_marking")$.

    From
    $E_c,\tau\vdash{}sitpn,s\srarrow{\downarrow}{\fontsize{5}{7}\selectfont}s'$,
    we know $s.M(p)=s'.M(p)$.

    By reasoning on the VHDL falling and stabilize relations, and on
    the Place component behavior, we know that the ``s\_marking'' is
    idle from state $\sigma_p$ to state $\sigma'_p$; thus,
    $\sigma_p("s\_marking")=\sigma'_p("s\_marking")$.

    Then, the goal is trivially proved by using the rewriting rules.
    
  \item Show $\omega=\sigma'_p("out\_arc\_w")(j)$.

    We know that $pre(p,t)=(\omega,\mathtt{basic})$ and
    $\mathtt{id_p.pauths(j)\Rightarrow{}sig\Rightarrow{}id_t.pauths(i)}$.
    
    Then, by construction, $\mathtt{id_p.output\_arcs\_weights(j)}$ is
    connected to the constant $\omega$ in the input map of Place
    component $id_p$.

    Then, the goal is trivially solved by showing that ports that are
    mapped to constant are idle during the simulation of a VHDL
    design.
    
  \item Show
    $\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)=\sum\limits_{k\in{}HPF(\sigma'_p,j)}\sigma'_p("out\_arc\_w")(k)$.

    We can show $\sum\limits_{t_i\in{}Pr(t,fired)}pre(p,t_i)=\sum\limits_{t_i\in{}Pr(p,t,fired)}pre(p,t_i)$\\
    where
    $t_i\in{}Pr(p,t,fired)\equiv{}t_i\succ{}t\land{}t_i\in{}fired\land\exists\omega\in\mathbb{N},~s.t.,~pre(p,t_i)=(\omega,\mathtt{basic})$.

    Then, we can show that the sets $Pr(p,t,fired)$ and
    $HPF(\sigma'_p,j)$ are in bijection, and that for each
    $t_i\in{}Pr(p,t,fired)$ mapped to a $k\in{}HPF(\sigma'_p,j)$, we
    have $pre(p,t_i)=\sigma'_p("out\_arc\_w")(k)$.

    2 subgoals to solve.
    
    \begin{enumerate}
    \item
      $\forall{}t_i\in{}Pr(p,t,fired),\exists{}k\in{}HPF(\sigma'_p,j)~s.t.~pre(p,t_i)=\sigma'_p("out\_arc\_w")(k)$.

      Given a transition $t_i\in{}Pr(p,t,fired)$, show
      $\exists{}k\in{}HPF(\sigma'_p,j)~s.t.~pre(p,t_i)=\sigma'_p("out\_arc\_w")(k)$.

      Unfold the definition of $t_i\in{}Pr(p,t,fired)$:
      \begin{itemize}
      \item $\exists\omega\in\mathbb{N}~s.t.~pre(p,t_i)=(\omega,\mathtt{basic})$.

        Let us call $\omega'$ the element of $\mathbb{N}^{*}$
        verifying $pre(p,t_i)=(\omega',\mathtt{basic})$.

        Then, by construction, there exists a Transition component
        $id_{t_i}$ implementing transition $t_i$ and an index
        $n\in\mathbb{N}^{*}$ such that $\mathtt{id_p.}$
        $\mathtt{output\_arcs\_weights(n)}$ is connected to $\omega'$
        and\\ $\mathtt{output\_arcs\_types(n)}$ is connected to
        $\mathtt{basic}$.

        Then, by reasoning on the VHDL falling and stabilize relation,
        we can show that
        $\sigma'_p("output\_arcs\_weights")(n)=\omega'$.
        
      \item $t_i\succ{}t$.

        By construction, there exists an index $m\in\mathbb{N}^{*}$
        and a signal $sig'\in\mathtt{Declared}(\Delta)$ such that
        $\mathtt{id_p.pauths(n)\Rightarrow{}sig'\Rightarrow{}id_{t_i}.pauths(m)}$
        
        Then, by construction, and since $t_i\succ{}t$, we know that
        $n<j$. Then, $n\in[0,j-1]$.
        
      \item $t_i\in{}fired$.

        Thanks to the EH, we know that $\sigma'_{t_i}("fired")=\mathtt{true}$.
        
        By construction, there exists a signal
        $sig''\in{}\mathtt{Declared}(\Delta)$ such that
        $\mathtt{id_{t_i}.fired\Rightarrow{}sig''\Rightarrow{}id_{p}.output\_transitions\_fired(n)}$.
        
        Then, by reasoning on the VHDL stabilize relation, we can
        deduce
        $\sigma'_p("output\_transitions\_fired")(n)=\sigma'_{t_i}("fired")=\mathtt{true}$.
        
      \end{itemize}

      Then, we have $n\in{}HPF(\sigma'_p,j)$ and
      $pre(p,t_i)=\sigma'_p("output\_arcs\_weights")(n)$.

      Thus, let us take $n$ to prove the goal by assumption.
      
    \item
      $\forall{}k\in{}HPF(\sigma'_p,j),\exists{}t_i\in{}Pr(p,t,fired)~s.t.~pre(p,t_i)=\sigma'_p("out\_arc\_w")(k)$.

      Given an index $k\in{}HPF(\sigma'_p,j)$, show
      $\exists{}t_i\in{}Pr(p,t,fired)~s.t.~pre(p,t_i)=\sigma'_p("out\_arc\_w")(k)$.

      Unfold the definition of $k\in{}HPF(\sigma'_p,j)$:

      \begin{itemize}
      \item $k\in[0,j-1]$.

        By construction, there exists a $t_i\in{}T$ and an
        $\omega'\in\mathbb{N}^{*}$ such that
        $pre(p,t_i)=(\omega',\mathtt{basic})$ and $t_i\succ{}t$ and
        $\mathtt{id_p.output\_arcs\_weights(k)\Rightarrow\omega'}$ and
        $\mathtt{id_p.output\_arcs\_types(k)\Rightarrow\mathtt{basic}}$.
        
      \item $\sigma'_p("output\_transitions\_fired")(k)=\mathtt{true}$.
        
        By construction, there exists a Transition component
        $id_{t_i}$ implementing transition $t_i$ such that
        $\mathtt{id_{t_i}.fired\Rightarrow{}id_p.output\_transitions\_fired(k)}$.

        Then, by reasoning on the VHDL falling and stabilize
        relations, we can deduce
        $\sigma'_p("output\_transitions\_fired")(k)=\sigma'_{t_i}("fired")=\mathtt{true}$.

        Then, thanks to EH, we know that $t_i\in{}fired$ or
        $t_i\in{}T_i$.

        \begin{itemize}
        \item CASE $t_i\in{}fired$. Then, take $t_i$ to prove the goal
          by assumption.
        \item CASE $t_i\in{}T_i$.

          Since $t$ is a \emph{top-priority} transition of set $T_i$
          (given by
          $IsTopPriorityList(T_i,\emptyset,\emptyset,\{t\}\cup{}tp$),
          then there exists no transition $t'\in{}T_i$ such that
          $t'\succ{}t$. Since $t_i\in{}T_i$, then we have
          $t_i\nsucc{}t$ contradicting $t_i\succ{}t$.
        \end{itemize}
      \end{itemize}
         
    \end{enumerate}
  \end{enumerate}

\end{proof}
